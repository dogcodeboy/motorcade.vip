---
- name: "31 - Header and Branding Layout Consolidation (motorcade-trust theme)"
  hosts: motorcade
  become: true

  vars:
    wp_root: /var/www/motorcade
    theme_slug: motorcade-trust
    theme_path: "{{ wp_root }}/wp-content/themes/{{ theme_slug }}"
    style_css: "{{ theme_path }}/style.css"

  tasks:
    - name: Stat theme style.css
      ansible.builtin.stat:
        path: "{{ style_css }}"
      register: mc_style

    - name: Fail if theme style.css not found
      ansible.builtin.fail:
        msg: "Expected theme file missing: {{ style_css }}"
      when: not mc_style.stat.exists

    - name: Backup style.css (timestamped)
      ansible.builtin.copy:
        src: "{{ style_css }}"
        dest: "{{ style_css }}.bak.{{ ansible_date_time.iso8601_basic_short }}"
        remote_src: true
        mode: preserve
      changed_when: false

    - name: Inject Playbook 31 header layout overrides into theme style.css
      ansible.builtin.blockinfile:
        path: "{{ style_css }}"
        marker: "/* {mark} MOTORCADE PLAYBOOK 31 HEADER LAYOUT */"
        insertafter: EOF
        block: |

          /*
           * Playbook 31: Header + Branding Layout Consolidation
           * Scope: layout, spacing, hierarchy, responsiveness
           * Rules: NO asset changes, NO wp-admin, theme-only CSS override
           */

          /* 1) Remove excess whitespace above header */
          body { margin-top: 0 !important; }

          /* 2) Suppress known duplicate legacy brandbar (if present) */
          .motorcade-brandbar { display: none !important; }

          /* 3) If a legacy duplicate brand element exists outside the header, hide it */
          body > .mc-brand,
          body > .mc-brandbar,
          .mc-brandbar + .mc-brand { display: none !important; }

          /* 4) Suppress WP Site Identity text, but do NOT hide the logo */
          .site-title,
          .site-description { display: none !important; }

          /* 5) Normalize logo/link box-model so it can align */
          .custom-logo-link,
          .custom-logo-link img,
          .custom-logo {
            margin: 0 !important;
            padding: 0 !important;
          }

          /* 6) Alignment fallback for the actual theme header DOM (safe, non-destructive)
           * Observed DOM (from curl):
           *  - header wrapper: .mc-header
           *  - nav: .mc-nav (a <nav>)
           *  - brand container: .motorcade-brand-inline
           *  - logo link: .custom-logo-link.mc-brand-link
           */
          .mc-header {
            display: flex !important;
            align-items: center !important;
            justify-content: space-between !important;
            gap: 16px !important;
            padding-top: 0 !important;
          }

          .mc-header .motorcade-brand-inline,
          .mc-header .custom-logo-link {
            display: flex !important;
            align-items: center !important;
            line-height: 1 !important;
          }

          /* Override any inline image baseline quirks */
          .mc-header .custom-logo-link img,
          .mc-header img.mc-brand-img,
          .mc-header img.mc-brand-badge {
            display: block !important;
            height: 44px !important;
            max-height: 44px !important;
            width: auto !important;
          }

          .mc-header .mc-nav {
            display: flex !important;
            align-items: center !important;
          }

          .mc-header .mc-nav ul,
          .mc-header .mc-nav .menu,
          .mc-header .mc-nav .nav-menu {
            display: flex !important;
            align-items: center !important;
            gap: 18px !important;
            margin: 0 !important;
            padding: 0 !important;
          }

          /* Ensure anchors don't introduce vertical drift */
          .mc-header .mc-nav a {
            line-height: 1.2 !important;
            padding-top: 0 !important;
            padding-bottom: 0 !important;
          }

          /* 7) Responsive behavior */
          @media (max-width: 900px) {
            .mc-header {
              flex-wrap: wrap !important;
              justify-content: flex-start !important;
              row-gap: 10px !important;
            }

            .mc-header .mc-nav {
              width: 100% !important;
            }

            .mc-header .mc-nav ul,
            .mc-header .mc-nav .menu,
            .mc-header .mc-nav .nav-menu {
              flex-wrap: wrap !important;
              row-gap: 10px !important;
            }
          }


    - name: Inject Playbook 31 header CTA cleanup (psychology-first)
      ansible.builtin.blockinfile:
        path: "{{ style_css }}"
        marker: "/* {mark} MOTORCADE PLAYBOOK 31 HEADER CTA CLEANUP */"
        insertafter: EOF
        block: |

          /*
           * Playbook 31 (CTA cleanup): Psychology-first header simplification
           * Goal: Reduce cognitive load to attract higher-quality leads.
           * Action: Hide the secondary header CTA (mc-btn-ghost) and keep a single primary CTA.
           */

          /* Hide secondary CTA in header only */
          .mc-header .mc-ctas .mc-btn-ghost {
            display: none !important;
          }

          /* Keep CTA container stable and prevent wrap */
          .mc-header .mc-ctas {
            display: flex !important;
            align-items: center !important;
            gap: 12px !important;
            flex-wrap: nowrap !important;
          }

          /* Prefer nav stays on one line on desktop */
          @media (min-width: 901px) {
            .mc-header .mc-nav ul,
            .mc-header .mc-nav .menu,
            .mc-header .mc-nav .nav-menu {
              flex-wrap: nowrap !important;
              white-space: nowrap !important;
            }
          }
    - name: Reload nginx
      ansible.builtin.service:
        name: nginx
        state: reloaded
