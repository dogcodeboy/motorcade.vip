---
# Playbook 24 — Deploy Motorcade image assets (uploads/motorcade/) + set FS_METHOD=direct safely
# Idempotent + Ansible-safe (no fragile regex escaping)

- name: "Playbook 24 — Deploy Motorcade image assets (uploads/motorcade/)"
  hosts: motorcade_web
  become: true
  vars:
    wp_root: /var/www/motorcade
    # Local (controller) source directory for assets (committed in repo)
    motorcade_assets_local_dir: "{{ playbook_dir }}/../files/wp/uploads/motorcade"
    # Remote destination directory
    motorcade_assets_remote_dir: "{{ wp_root }}/wp-content/uploads/motorcade"
    # Whether to try registering files into the WP Media Library
    register_media_library: false

  tasks:
    - name: Gathering Facts
      ansible.builtin.setup:

    - name: Assert WordPress root exists
      ansible.builtin.stat:
        path: "{{ wp_root }}/wp-config.php"
      register: wp_cfg

    - name: Fail if WordPress root not found
      ansible.builtin.fail:
        msg: "WordPress root not found at {{ wp_root }} (missing wp-config.php)."
      when: not wp_cfg.stat.exists

    - name: Assert local assets directory exists on controller
      ansible.builtin.stat:
        path: "{{ motorcade_assets_local_dir }}"
      delegate_to: localhost
      become: false
      register: local_assets_dir

    - name: Fail if local assets are missing (controller)
      ansible.builtin.fail:
        msg: "Local assets directory missing: {{ motorcade_assets_local_dir }}"
      when: not local_assets_dir.stat.exists

    - name: Ensure Motorcade uploads directory exists
      ansible.builtin.file:
        path: "{{ motorcade_assets_remote_dir }}"
        state: directory
        owner: nginx
        group: nginx
        mode: '0755'

    - name: Copy Motorcade image assets into uploads (idempotent)
      ansible.builtin.copy:
        src: "{{ motorcade_assets_local_dir }}/"
        dest: "{{ motorcade_assets_remote_dir }}/"
        owner: nginx
        group: nginx
        mode: '0644'
        directory_mode: '0755'

    - name: Fix ownership (recursive)
      ansible.builtin.file:
        path: "{{ wp_root }}/wp-content/uploads"
        state: directory
        owner: nginx
        group: nginx
        recurse: true

    - name: Ensure uploads directory perms (dirs 0755, files 0644)
      ansible.builtin.shell: |
        set -euo pipefail
        find "{{ wp_root }}/wp-content/uploads" -type d -exec chmod 0755 {} \;
        find "{{ wp_root }}/wp-content/uploads" -type f -exec chmod 0644 {} \;
      args:
        executable: /bin/bash

    # FS_METHOD=direct makes WP able to write updates/plugins/themes when needed.
    # Use blockinfile to avoid brittle regex escaping.
    - name: Ensure FS_METHOD is set to direct (managed block)
      ansible.builtin.blockinfile:
        path: "{{ wp_root }}/wp-config.php"
        marker: "// {mark} MOTORCADE_FS_METHOD"
        insertbefore: "^/\\* That's all, stop editing! \\*/"
        block: |
          define('FS_METHOD', 'direct');
      notify:
        - reload php-fpm

    - name: Check if wp-cli exists
      ansible.builtin.command: "wp --info"
      register: wpcli
      changed_when: false
      failed_when: false

    - name: "Optional: Register assets in Media Library (wp-cli)"
      ansible.builtin.command: >-
        wp --path={{ wp_root }} media import {{ motorcade_assets_remote_dir }}/* --skip-themes --skip-plugins
      when:
        - register_media_library | bool
        - wpcli.rc == 0
      register: media_import
      changed_when: "'Imported' in (media_import.stdout | default(''))"

  handlers:
    - name: reload php-fpm
      ansible.builtin.service:
        name: php-fpm
        state: reloaded
