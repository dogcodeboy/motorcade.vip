---
- name: "Playbook 30 - Branding: Shield-only logo assets + header enforcement"
  hosts: motorcade_web
  become: true

  vars:
    wp_path: /var/www/motorcade
    theme_slug: motorcade-trust
    theme_dir: "{{ wp_path }}/wp-content/themes/{{ theme_slug }}"

    uploads_brand_dir: "{{ wp_path }}/wp-content/uploads/motorcade/branding"
    brand_url_base: "https://motorcade.vip/wp-content/uploads/motorcade/branding"

    # Local repo asset source directory (relative to ansible/)
    repo_brand_assets: "{{ playbook_dir }}/../files/wp/assets/images/motorcade/branding"

    # Shield-only assets we allow (everything else gets removed from uploads)
    shield_assets:
      - motorcade-badge-40.png
      - motorcade-badge-48.png
      - motorcade-badge-64.png
      - motorcade-badge-96.png
      - motorcade-badge-128.png
      - motorcade-badge-256.png
      - motorcade-badge-512.png
      - motorcade-site-icon-512.png
      - motorcade-header-logo.png
      - motorcade-header-logo-light.png
      - motorcade-header-logo-dark.png

    # Any legacy / accidental assets we want removed from uploads to prevent regressions
    legacy_brand_assets:
      - motorcade-header-combo-dark.png
      - motorcade-header-combo-dark-raw.png
      - motorcade-header-combo-light.png
      - motorcade-header-combo-light-raw.png
      - motorcade-wordmark-dark.png
      - motorcade-wordmark-dark-fixed.png
      - motorcade-wordmark-light.png
      - wordmark_dark.png
      - wordmark_light.png

  tasks:
    - name: Assert theme directory exists
      ansible.builtin.stat:
        path: "{{ theme_dir }}"
      register: theme_stat

    - name: Fail if theme directory missing
      ansible.builtin.fail:
        msg: "Theme directory not found: {{ theme_dir }}"
      when: not theme_stat.stat.exists

    - name: Ensure uploads branding directory exists
      ansible.builtin.file:
        path: "{{ uploads_brand_dir }}"
        state: directory
        owner: nginx
        group: nginx
        mode: "0755"

    - name: Remove legacy/accidental branding assets from uploads (idempotent)
      ansible.builtin.file:
        path: "{{ uploads_brand_dir }}/{{ item }}"
        state: absent
      loop: "{{ legacy_brand_assets }}"

    - name: Upload shield-only branding assets to wp-content/uploads (idempotent)
      ansible.builtin.copy:
        src: "{{ repo_brand_assets }}/{{ item }}"
        dest: "{{ uploads_brand_dir }}/{{ item }}"
        owner: nginx
        group: nginx
        mode: "0644"
      loop: "{{ shield_assets }}"

    - name: Verify wp-cli exists
      ansible.builtin.command: wp --info
      args:
        chdir: "{{ wp_path }}"
      become_user: nginx
      changed_when: false

    - name: Ensure functions.php exists
      ansible.builtin.stat:
        path: "{{ theme_dir }}/functions.php"
      register: functions_stat

    - name: Fail if functions.php missing
      ansible.builtin.fail:
        msg: "Missing theme functions.php at {{ theme_dir }}/functions.php"
      when: not functions_stat.stat.exists

    - name: Ensure style.css exists
      ansible.builtin.stat:
        path: "{{ theme_dir }}/style.css"
      register: style_stat

    - name: Fail if style.css missing
      ansible.builtin.fail:
        msg: "Missing theme style.css at {{ theme_dir }}/style.css"
      when: not style_stat.stat.exists

    - name: Import shield assets to Media Library (best-effort)
      ansible.builtin.command: >
        wp --path={{ wp_path }} media import
        {{ uploads_brand_dir }}/motorcade-site-icon-512.png
        {{ uploads_brand_dir }}/motorcade-badge-256.png
        --porcelain
      become_user: nginx
      register: media_import
      changed_when: false
      failed_when: false

    - name: Enforce shield-only header branding (no wordmark/combo) (idempotent)
      ansible.builtin.blockinfile:
        path: "{{ theme_dir }}/functions.php"
        marker: "// MOTORCADE_BRAND_CUSTOMIZER {mark}"
        insertafter: EOF
        block: |
          /**
           * Motorcade Branding â€” Shield-only assets
           * Managed by Ansible (Playbook 30). Do not edit inside markers.
           */
          add_action('customize_register', function($wp_customize) {
            $section = 'motorcade_branding';

            if (!$wp_customize->get_section($section)) {
              $wp_customize->add_section($section, [
                'title'       => 'Motorcade Branding',
                'priority'    => 25,
                'description' => 'Shield-only branding (repo-managed).',
              ]);
            }

            // Show always-on brand bar (recommended for recognition / trust)
            $wp_customize->add_setting('motorcade_brandbar_enabled', [
              'default'           => true,
              'sanitize_callback' => function($v){ return (bool)$v; }
            ]);
            $wp_customize->add_control('motorcade_brandbar_enabled', [
              'type'    => 'checkbox',
              'section' => $section,
              'label'   => 'Show Brand Bar (shield icon in header)',
            ]);

            // Shield badge URL (image control)
            $wp_customize->add_setting('motorcade_logo_badge_url', [
              'default'           => '{{ brand_url_base }}/motorcade-badge-64.png',
              'sanitize_callback' => 'esc_url_raw',
            ]);
            $wp_customize->add_control(new WP_Customize_Image_Control($wp_customize, 'motorcade_logo_badge_url', [
              'label'   => 'Shield badge image',
              'section' => $section,
              'settings'=> 'motorcade_logo_badge_url',
            ]));

            // Header logo (shield only)
            $wp_customize->add_setting('motorcade_logo_header_url', [
              'default'           => '{{ brand_url_base }}/motorcade-header-logo-light.png',
              'sanitize_callback' => 'esc_url_raw',
            ]);
            $wp_customize->add_control(new WP_Customize_Image_Control($wp_customize, 'motorcade_logo_header_url', [
              'label'   => 'Header logo (shield)',
              'section' => $section,
              'settings'=> 'motorcade_logo_header_url',
            ]));
          });

          /**
           * Render Motorcade shield logo.
           */
          function motorcade_brand_logo_html($args = []) {
            $defaults = [
              'class' => 'mc-brand-logo',
              'alt'   => 'Motorcade Security Solutions',
            ];
            $args = array_merge($defaults, is_array($args) ? $args : []);

            $src = get_theme_mod('motorcade_logo_header_url', '{{ brand_url_base }}/motorcade-header-logo-light.png');
            $src = esc_url($src);
            return '<img class="'.esc_attr($args['class']).'" src="'.$src.'" alt="'.esc_attr($args['alt']).'" loading="eager" decoding="async" />';
          }

          /**
           * Brand Bar: guarantees visible branding even if header template doesn't output the Custom Logo.
           * Shield-only; no wordmark text.
           */
          add_action('wp_body_open', function(){
            if (!get_theme_mod('motorcade_brandbar_enabled', true)) return;

            $logo = motorcade_brand_logo_html(['class' => 'mc-brand-logo mc-brand-logo--bar']);
            $home = esc_url(home_url('/'));
            echo '<div class="mc-brandbar" role="banner">'
               . '<a class="mc-brandbar__link" href="'.$home.'" rel="home" aria-label="Motorcade">'
               . $logo
               . '</a>'
               . '</div>';
          }, 5);

          // If the theme uses the WordPress Custom Logo, replace it with our shield asset.
          add_filter('get_custom_logo', function($html){
            if (!$html) return $html;
            $logo = motorcade_brand_logo_html(['class' => 'custom-logo']);
            $home = esc_url(home_url('/'));
            return '<a href="'.$home.'" class="custom-logo-link mc-brand-link" rel="home" aria-label="Motorcade">'.$logo.'</a>';
          }, 20);

    - name: Append Motorcade shield-only logo CSS (idempotent)
      ansible.builtin.blockinfile:
        path: "{{ theme_dir }}/style.css"
        marker: "/* MOTORCADE_BRAND_LOGO_CSS {mark} */"
        insertafter: EOF
        block: |
          /* === Motorcade Branding (Ansible-managed) === */
          .mc-brandbar {
            position: sticky;
            top: 0;
            z-index: 999;
            background: #ffffff;
            border-bottom: 1px solid rgba(15, 23, 42, 0.08);
          }
          .mc-brandbar__link {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 16px;
            text-decoration: none;
          }
          .mc-brand-logo, .custom-logo {
            height: 40px;
            width: auto;
            max-width: 64px; /* shield only */
          }
          .mc-brand-logo--bar { height: 34px; }
          @media (min-width: 768px) {
            .mc-brand-logo, .custom-logo { height: 44px; max-width: 72px; }
            .mc-brand-logo--bar { height: 36px; }
          }

    - name: Set default theme mods (shield-only) (best-effort)
      ansible.builtin.command: >
        wp --path={{ wp_path }} theme mod set {{ item.key }} {{ item.value }}
      become_user: nginx
      loop:
        - { key: motorcade_logo_badge_url, value: "{{ brand_url_base }}/motorcade-badge-64.png" }
        - { key: motorcade_logo_header_url, value: "{{ brand_url_base }}/motorcade-header-logo-light.png" }
        - { key: motorcade_brandbar_enabled, value: 1 }
      changed_when: false
      failed_when: false

    - name: Reload php-fpm
      ansible.builtin.service:
        name: php-fpm
        state: reloaded
      ignore_errors: true

    - name: Reload nginx
      ansible.builtin.service:
        name: nginx
        state: reloaded
      ignore_errors: true

    - name: Print summary
      ansible.builtin.debug:
        msg:
          - "Uploaded shield-only branding assets to: {{ uploads_brand_dir }}"
          - "Removed legacy combo/wordmark assets from uploads to prevent regressions."
          - "Brand Bar outputs shield-only (no wordmark text)."
          - "Homepage: https://motorcade.vip"
