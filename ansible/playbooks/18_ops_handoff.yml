---
- name: "Motorcade Playbook 18 - Ops Handoff & Day-2 Runbook"
  hosts: motorcade
  become: true
  gather_facts: true

  vars:
    motorcade_ops_log_root: "/var/log/motorcade"
    motorcade_health_script: "/usr/local/sbin/motorcade-healthcheck.sh"
    motorcade_diag_script: "/usr/local/sbin/motorcade-diagnostics.sh"
    motorcade_domain: "motorcade.vip"

  tasks:
    - name: "Ensure ops log directories exist"
      ansible.builtin.file:
        path: "{{ item }}"
        state: directory
        owner: root
        group: root
        mode: "0750"
      loop:
        - "{{ motorcade_ops_log_root }}"
        - "{{ motorcade_ops_log_root }}/diagnostics"

    - name: "Install healthcheck script"
      ansible.builtin.copy:
        dest: "{{ motorcade_health_script }}"
        owner: root
        group: root
        mode: "0750"
        content: |
          #!/usr/bin/env bash
          set -euo pipefail

          TS="$(date +%Y%m%d-%H%M%S)"
          LOG_DIR="{{ motorcade_ops_log_root }}"
          LOG_FILE="${LOG_DIR}/health-${TS}.log"
          exec > >(tee -a "${LOG_FILE}") 2>&1

          echo "[motorcade] healthcheck ${TS}"
          echo "--- nginx -t"
          nginx -t
          echo "--- nginx status"
          systemctl status nginx --no-pager -l | head -n 40 || true
          echo "--- php-fpm status"
          systemctl status php-fpm --no-pager -l | head -n 40 || true
          echo "--- https head"
          curl -I "https://{{ motorcade_domain }}" | head
          echo "[motorcade] healthcheck complete"

    - name: "Install diagnostics script"
      ansible.builtin.copy:
        dest: "{{ motorcade_diag_script }}"
        owner: root
        group: root
        mode: "0750"
        content: |
          #!/usr/bin/env bash
          set -euo pipefail

          TS="$(date +%Y%m%d-%H%M%S)"
          OUT_DIR="{{ motorcade_ops_log_root }}/diagnostics/diag-${TS}"
          mkdir -p "${OUT_DIR}"

          echo "[motorcade] diagnostics ${TS}" > "${OUT_DIR}/README.txt"

          {
            echo "== date =="; date
            echo
            echo "== uname =="; uname -a
            echo
            echo "== df -h =="; df -h
            echo
            echo "== free -m =="; free -m || true
          } > "${OUT_DIR}/system.txt" 2>&1

          {
            echo "== nginx -t =="; nginx -t
            echo
            echo "== nginx status =="; systemctl status nginx --no-pager -l | head -n 80
            echo
            echo "== php-fpm status =="; systemctl status php-fpm --no-pager -l | head -n 80
          } > "${OUT_DIR}/services.txt" 2>&1 || true

          {
            echo "== nginx conf list =="; find /etc/nginx -maxdepth 3 -type f | sort
          } > "${OUT_DIR}/nginx-files.txt" 2>&1 || true

          {
            echo "== recent nginx error log =="; tail -n 200 /var/log/nginx/error.log || true
            echo
            echo "== recent nginx access log =="; tail -n 200 /var/log/nginx/access.log || true
            echo
            echo "== recent php-fpm log =="; tail -n 200 /var/log/php-fpm/error.log || true
          } > "${OUT_DIR}/logs.txt" 2>&1 || true

          tar -C "{{ motorcade_ops_log_root }}/diagnostics" -czf "{{ motorcade_ops_log_root }}/diagnostics/diag-${TS}.tar.gz" "diag-${TS}"
          echo "Bundle: {{ motorcade_ops_log_root }}/diagnostics/diag-${TS}.tar.gz"

    - name: "Install logrotate for /var/log/motorcade"
      ansible.builtin.copy:
        dest: "/etc/logrotate.d/motorcade"
        owner: root
        group: root
        mode: "0644"
        content: |
          {{ motorcade_ops_log_root }}/*.log {
            daily
            rotate 14
            missingok
            notifempty
            compress
            delaycompress
            copytruncate
          }

    - name: "Show ops commands"
      ansible.builtin.debug:
        msg:
          - "Healthcheck: sudo {{ motorcade_health_script }}"
          - "Diagnostics: sudo {{ motorcade_diag_script }}"
          - "Diagnostics bundles: {{ motorcade_ops_log_root }}/diagnostics"
