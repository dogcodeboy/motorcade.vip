---
- name: Motorcade - WordPress filesystem + PHP-FPM user alignment (nginx) + uploads fix
  hosts: motorcade
  become: true

  vars:
    # Adjust if your docroot differs
    wp_root: /var/www/motorcade
    wp_config: /var/www/motorcade/wp-config.php

    # This must match your Nginx user/group on Amazon Linux / RHEL-ish setups
    web_user: nginx
    web_group: nginx

    # PHP-FPM pool config on Amazon Linux 2023 / RHEL family
    php_fpm_pool_conf: /etc/php-fpm.d/www.conf
    php_fpm_service: php-fpm
    nginx_service: nginx

    # WordPress writable paths
    wp_content: "{{ wp_root }}/wp-content"
    wp_uploads: "{{ wp_content }}/uploads"

  tasks:
    - name: Assert WordPress root exists
      ansible.builtin.stat:
        path: "{{ wp_root }}"
      register: wp_root_stat

    - name: Fail if WordPress root not found
      ansible.builtin.fail:
        msg: "WordPress root not found at {{ wp_root }}. Fix wp_root in vars."
      when: not wp_root_stat.stat.exists

    # -----------------------------
    # 1) Fix the REAL root cause:
    #    php-fpm pool user/group must match nginx
    # -----------------------------
    - name: Ensure php-fpm pool runs as nginx user
      ansible.builtin.lineinfile:
        path: "{{ php_fpm_pool_conf }}"
        regexp: '^user\s*='
        line: "user = {{ web_user }}"
        create: false
        backup: true
      register: php_fpm_user_change

    - name: Ensure php-fpm pool runs as nginx group
      ansible.builtin.lineinfile:
        path: "{{ php_fpm_pool_conf }}"
        regexp: '^group\s*='
        line: "group = {{ web_group }}"
        create: false
        backup: true
      register: php_fpm_group_change

    - name: Ensure php-fpm listens on unix socket (recommended)
      ansible.builtin.lineinfile:
        path: "{{ php_fpm_pool_conf }}"
        regexp: '^listen\s*='
        line: "listen = /run/php-fpm/www.sock"
        create: false
        backup: true
      register: php_fpm_listen_change

    - name: Ensure socket owner is nginx
      ansible.builtin.lineinfile:
        path: "{{ php_fpm_pool_conf }}"
        regexp: '^listen\.owner\s*='
        line: "listen.owner = {{ web_user }}"
        create: false
        backup: true
      register: php_fpm_sock_owner_change

    - name: Ensure socket group is nginx
      ansible.builtin.lineinfile:
        path: "{{ php_fpm_pool_conf }}"
        regexp: '^listen\.group\s*='
        line: "listen.group = {{ web_group }}"
        create: false
        backup: true
      register: php_fpm_sock_group_change

    - name: Ensure socket mode allows nginx to read/write
      ansible.builtin.lineinfile:
        path: "{{ php_fpm_pool_conf }}"
        regexp: '^listen\.mode\s*='
        line: "listen.mode = 0660"
        create: false
        backup: true
      register: php_fpm_sock_mode_change

    - name: Restart php-fpm if pool config changed
      ansible.builtin.service:
        name: "{{ php_fpm_service }}"
        state: restarted
        enabled: true
      when: >
        php_fpm_user_change.changed or
        php_fpm_group_change.changed or
        php_fpm_listen_change.changed or
        php_fpm_sock_owner_change.changed or
        php_fpm_sock_group_change.changed or
        php_fpm_sock_mode_change.changed

    # -----------------------------
    # 2) Ensure required dirs exist
    # -----------------------------
    - name: Ensure wp-content exists
      ansible.builtin.file:
        path: "{{ wp_content }}"
        state: directory
        owner: "{{ web_user }}"
        group: "{{ web_group }}"
        mode: "0755"

    - name: Ensure uploads directory exists and is writable
      ansible.builtin.file:
        path: "{{ wp_uploads }}"
        state: directory
        owner: "{{ web_user }}"
        group: "{{ web_group }}"
        mode: "0775"
        recurse: true

    # -----------------------------
    # 3) Fix ownership of the whole WP tree
    #    (keeps it simple and consistent)
    # -----------------------------
    - name: Ensure correct ownership for all WordPress files
      ansible.builtin.file:
        path: "{{ wp_root }}"
        owner: "{{ web_user }}"
        group: "{{ web_group }}"
        recurse: true

    # -----------------------------
    # 4) Standard perms: dirs 755, files 644
    #    (uploads stays writable because dir is 775 + ownership nginx)
    # -----------------------------
    - name: Ensure directory permissions (755) under WP root
      ansible.builtin.command: >
        find {{ wp_root }} -type d -exec chmod 755 {} \;
      changed_when: false

    - name: Ensure file permissions (644) under WP root
      ansible.builtin.command: >
        find {{ wp_root }} -type f -exec chmod 644 {} \;
      changed_when: false

    # -----------------------------
    # 5) Force WordPress to use direct filesystem writes
    # -----------------------------
    - name: Ensure FS_METHOD is set to direct in wp-config.php
      ansible.builtin.lineinfile:
        path: "{{ wp_config }}"
        line: "define('FS_METHOD', 'direct');"
        state: present
        insertbefore: "^/\\* That's all, stop editing! Happy publishing\\. \\*/"
      register: fs_method_change

    # -----------------------------
    # 6) Reload services (safe + keeps site up)
    # -----------------------------
    - name: Reload php-fpm if FS_METHOD changed (harmless)
      ansible.builtin.service:
        name: "{{ php_fpm_service }}"
        state: reloaded
      when: fs_method_change.changed

    - name: Reload nginx
      ansible.builtin.service:
        name: "{{ nginx_service }}"
        state: reloaded

    # -----------------------------
    # 7) Validation: prove nginx user can write uploads
    # -----------------------------
    - name: Validate nginx can write to uploads
      ansible.builtin.shell: |
        set -e
        sudo -u {{ web_user }} bash -lc 'touch "{{ wp_uploads }}/.perm_test" && rm -f "{{ wp_uploads }}/.perm_test"'
      args:
        executable: /bin/bash
      changed_when: false

